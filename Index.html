<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <title>Propulsion</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            height: 100%;
            width: 100%;
        }

    </style>
</head>
<body>
<script src="Scripts/three.js"></script>
<script src="Scripts/di4js.js"></script>
<script src="Game/Game.js"></script>
<script src="Game/Ship.js"></script>
<script src="Game/ShipFactory.js"></script>
<script src="Game/ThreeJsWorld.js"></script>
<script src="Game/Missile.js"></script>
<script src="Game/MissileFactory.js"></script>
<script src="Game/SimplePhysics.js"></script>
<script src="Game/Server.js"></script>
<script src="Game/DependencyInversionWireUp.js"></script>
<script>
    (function() {
        var game = di.resolve('game');

        game.init();

        var setCanvas = function() {
            game.setCanvas();
        };
        setCanvas();

        window.addEventListener('resize', setCanvas, false);

        game.start();

        var ship1 = game.ships[0];
        var ship2 = game.ships[1];
        var pressed = {};
        window.addEventListener('keydown', function(event) {
            if (pressed[event.keyCode]) {
                return;
            }
            pressed[event.keyCode] = true;

            switch (event.keyCode) {
            case 38:
                ship1.startBoost();
                break;
            case 37:
                ship1.startSteerLeft();
                break;
            case 39:
                ship1.startSteerRight();
                break;
            case 32:
                ship1.shoot();
                break;
            case 87:
                ship2.startBoost();
                break;
            case 65:
                ship2.startSteerLeft();
                break;
            case 68:
                ship2.startSteerRight();
                break;
            case 17:
                ship2.shoot();
                break;
            case 83:
                ship2.remoteBoost();
                break;
            }
        });

        window.addEventListener('keyup', function(event) {
            pressed[event.keyCode] = false;
            switch (event.keyCode) {
            case 38:
                ship1.stopBoost();
                break;
            case 37:
                ship1.stopSteerLeft();
                break;
            case 39:
                ship1.stopSteerRight();
                break;
            case 87:
                ship2.stopBoost();
                break;
            case 65:
                ship2.stopSteerLeft();
                break;
            case 68:
                ship2.stopSteerRight();
                break;
            }
        });

        var initialTouch = null;
        var shooting = function(touch) {
            return touch.pageX > window.innerWidth / 2;
        };
        window.addEventListener('touchstart', function(event) {
            var touch = event.changedTouches[0];
            if (shooting(touch)) {
                ship1.shoot();
            } else {
                initialTouch = initialTouch || { x: touch.pageX, y: touch.pageY };
            }
        }, false);

        var overTreshold = function(amount) {
            // Todo: treshold should be relative to window.innerWidth and height.
            var treshold = 20;
            return Math.abs(amount) > treshold;
        };
        window.addEventListener('touchmove', function(event) {
            event.preventDefault();
            var touch = event.changedTouches[0];
            if (shooting(touch) || !initialTouch) {
                return;
            }

            var vector = { x: touch.pageX - initialTouch.x, y: touch.pageY - initialTouch.y };

            if (overTreshold(vector.x)) {
                if (vector.x > 0) {
                    ship1.startSteerRight();
                } else {
                    ship1.startSteerLeft();
                }
            }

            if (overTreshold(vector.y)) {
                if (vector.y < 0) {
                    ship1.startBoost();
                } else {
                    ship1.stopBoost();
                }
            }
        }, false);

        var onTouchEnd = function(event) {
            // Todo: is [0] really the right touch?
            var touch = event.changedTouches[0];
            if (!shooting(touch)) {
                initialTouch = null;
                ship1.stopBoost();
                ship1.stopSteerLeft();
                ship1.stopSteerRight();
            }
        };
        window.addEventListener('touchend', onTouchEnd, false);
        window.addEventListener('touchcancel', onTouchEnd, false);

        //var socket = new WebSocket('ws://localhost:3000');

        //socket.onopen = function() {
        //    socket.send('Haha');
        //};

        //socket.onmessage = function(event) {
        //    console.log(event.data);
        //};
    })();
</script>
</body>
</html>